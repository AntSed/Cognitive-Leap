<!-- File: components/TheTree.client.vue -->
<template>
  <div class="sv-wrapper" ref="wrapperRef">
    <canvas ref="canvasRef"></canvas>
  </div>
</template>

<script setup>
import { onMounted, onUnmounted, ref } from 'vue';
import * as THREE from 'three';
import { SVGLoader } from 'three/examples/jsm/loaders/SVGLoader.js';
import { FontLoader } from 'three/examples/jsm/loaders/FontLoader.js';
import { TextGeometry } from 'three/examples/jsm/geometries/TextGeometry.js';
import * as BufferGeometryUtils from 'three/examples/jsm/utils/BufferGeometryUtils.js';

// --- ИМПОРТИРУЕМ ГЛОБАЛЬНОЕ ХРАНИЛИЩЕ ---
import { useModalStore } from '~/composables/useModalStore';

// --- CONFIGURATION ---
const CONFIG = {
  CAMERA_INITIAL_POSITION: [0, 0, 80],
  PAN_SENSITIVITY: 0.1,
  ZOOM_SENSITIVITY: 0.05,
  ZOOM_RANGE: { min: 1.0, max: 10.0 },
  TREE_IMAGE: {
    url: 'https://cdopmabluqeueagtsjlv.supabase.co/storage/v1/object/public/3d/tree.png', 
    width: 60, height: 60, position: [0, 0, -0.1],
  },
  LESSON_NODE: {
    SCALE: 0.5,
    FONT_URL: 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/fonts/helvetiker_regular.typeface.json',
    TEXT_SIZE: 0.25,
    FRUIT_COLORS: { 
      start: 0x197a0c, // Dark Green
      end: 0xFF0000   // Bright Red
    }
  },
};

// --- FINAL SVG ICON DATA & FACTORY ---
const IconFactory = {
    _loader: new SVGLoader(),
    _cache: {},
    createGeometry(shapeName) {
        if (this._cache[shapeName]) {
            return this._cache[shapeName].clone();
        }
        const svgPaths = {
            'Coin': '<path d="M444-200h70v-50q50-9 86-39t36-89q0-42-24-77t-96-61q-60-20-83-35t-23-41q0-26 18.5-41t53.5-15q32 0 50 15.5t26 38.5l64-26q-11-35-40.5-61T516-710v-50h-70v50q-50 11-78 44t-28 74q0 47 27.5 76t86.5 50q63 23 87.5 41t24.5 47q0 33-23.5 48.5T486-314q-33 0-58.5-20.5T390-396l-66 26q14 48 43.5 77.5T444-252v52Zm36 120q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/>',
            'Lightning': '<path d="m422-232 207-248H469l29-227-185 267h139l-30 208ZM320-80l40-280H160l360-520h80l-40 320h240L400-80h-80Zm151-390Z"/>',
            'Flask': '<path d="M200-120q-51 0-72.5-45.5T138-250l222-270v-240h-40q-17 0-28.5-11.5T280-800q0-17 11.5-28.5T320-840h320q17 0 28.5 11.5T680-800q0 17-11.5 28.5T640-760h-40v240l222 270q32 39 10.5 84.5T760-120H200Zm80-120h400L544-400H416L280-240Zm-80 40h560L520-492v-268h-80v268L200-200Zm280-280Z"/>',
            'Cell': '<path d="M600-80q-17 0-28.5-11.5T560-120v-43q-23-4-43.5-11.5T478-195l-40 40q-12 11-28.5 11.5T381-155q-12-12-12-28.5t12-28.5l41-41q-3-5-6-10.5t-6-10.5l-27-53-49 49q-12 11-28 11.5T278-278q-12-12-12-28t12-28l49-50-53-26q-5-2-9-4.5t-9-5.5l-36 36q-12 11-28.5 11.5T163-384q-12-12-12-28t12-28l35-35q-14-19-22.5-40.5T163-560h-43q-17 0-28.5-11.5T80-600q0-17 11.5-28.5T120-640h45q5-19 12-36t18-33l-35-35q-12-12-12-28t12-28q12-12 28-12t28 12l35 35q16-11 33-18t36-12v-45q0-17 11.5-28.5T360-880q17 0 28.5 11.5T400-840v43q24 4 45.5 13t40.5 23l35-35q12-12 28.5-12t28.5 12q12 12 12 28t-12 28l-37 37q2 4 4.5 8t4.5 9l25 50 46-46q12-12 28.5-12t28.5 12q12 12 12 28.5T678-625l-48 47 56 28q6 3 12.5 6.5T710-536l40-40q12-12 28-12t28 12q12 12 12 28.5T806-519l-40 39q12 18 19.5 38t11.5 42h43q17 0 28.5 11.5T880-360q0 17-11.5 28.5T840-320h-45q-5 19-12 35.5T765-252l34 34q12 12 12 28.5T799-161q-12 11-28.5 11.5T742-161l-33-34q-16 11-33 18t-36 12v45q0 17-11.5 28.5T600-80Zm-6-160q58 0 95.5-44T718-386q-5-30-22.5-54T650-478l-66-34q-23-12-41.5-30.5T512-584l-34-66q-16-32-46-51t-66-19q-58 0-95.5 44T242-574q5 30 22.5 54t45.5 38l66 34q23 12 41.5 30.5T448-376l34 66q16 32 46 51t66 19ZM380-540q25 0 42.5-17.5T440-600q0-25-17.5-42.5T380-660q-25 0-42.5 17.5T320-600q0 25 17.5 42.5T380-540Zm200 250q21 0 35.5-14.5T630-340q0-21-14.5-35.5T580-390q-21 0-35.5 14.5T530-340q0 21 14.5 35.5T580-290ZM480-480Z"/>',
            'Calculator': '<path d="M320-240h60v-80h80v-60h-80v-80h-60v80h-80v60h80v80Zm200-30h200v-60H520v60Zm0-100h200v-60H520v60Zm44-152 56-56 56 56 42-42-56-58 56-56-42-42-56 56-56-56-42 42 56 56-56 58 42 42Zm-314-70h200v-60H250v60Zm-50 472q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0-560v560-560Z"/>',
            'Globe': '<path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-155.5t86-127Q252-817 325-848.5T480-880q83 0 155.5 31.5t127 86q54.5 54.5 86 127T880-480q0 82-31.5 155t-86 127.5q-54.5 54.5-127 86T480-80Zm0-82q26-36 45-75t31-83H404q12 44 31 83t45 75Zm-104-16q-18-33-31.5-68.5T322-320H204q29 50 72.5 87t99.5 55Zm208 0q56-18 99.5-55t72.5-87H638q-9 38-22.5 73.5T584-178ZM170-400h136q-3-20-4.5-39.5T300-480q0-21 1.5-40.5T306-560H170q-5 20-7.5 39.5T160-480q0 21 2.5 40.5T170-400Zm216 0h188q3-20 4.5-39.5T580-480q0-21-1.5-40.5T574-560H386q-3 20-4.5 39.5T380-480q0 21 1.5 40.5T386-400Zm268 0h136q5-20 7.5-39.5T800-480q0-21-2.5-40.5T790-560H654q3 20 4.5 39.5T660-480q0 21-1.5 40.5T654-400Zm-16-240h118q-29-50-72.5-87T584-782q18 33 31.5 68.5T638-640Zm-234 0h152q-12-44-31-83t-45-75q-26 36-45 75t-31 83Zm-200 0h118q9-38 22.5-73.5T376-782q-56 18-99.5 55T204-640Z"/>',
            'Terminal': '<path d="M160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm0-80h640v-400H160v400Zm140-40-56-56 103-104-104-104 57-56 160 160-160 160Zm180 0v-80h240v80H480Z"/>',
            'Clock': '<path d="M480-120q-138 0-240.5-91.5T122-440h82q14 104 92.5 172T480-200q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h110v80H120v-240h80v94q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z"/>',
            'Gears': '<path d="m234-480-12-60q-12-5-22.5-10.5T178-564l-58 18-40-68 46-40q-2-13-2-26t2-26l-46-40 40-68 58 18q11-8 21.5-13.5T222-820l12-60h80l12 60q12 5 22.5 10.5T370-796l58-18 40 68-46 40q2 13 2 26t-2 26l46 40-40 68-58-18q-11 8-21.5 13.5T326-540l-12 60h-80Zm40-120q33 0 56.5-23.5T354-680q0-33-23.5-56.5T274-760q-33 0-56.5 23.5T194-680q0 33 23.5 56.5T274-600ZM592-40l-18-84q-17-6-31.5-14.5T514-158l-80 26-56-96 64-56q-2-18-2-36t2-36l-64-56 56-96 80 26q14-11 28.5-19.5T574-516l18-84h112l18 84q17 6 31.5 14.5T782-482l80-26 56 96-64 56q2 18 2 36t-2 36l64 56-56 96-80-26q-14 11-28.5 19.5T722-124l-18 84H592Zm56-160q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Z"/>',
            'Stars': '<path d="m354-287 126-76 126 77-33-144 111-96-146-13-58-136-58 135-146 13 111 97-33 143ZM233-120l65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Zm457-560 21-89-71-59 94-8 36-84 36 84 94 8-71 59 21 89-80-47-80 47ZM480-481Z"/>',
            'Scales': '<path d="M80-120v-80h360v-447q-26-9-45-28t-28-45H240l120 280q0 50-41 85t-99 35q-58 0-99-35t-41-85l120-280h-80v-80h247q12-35 43-57.5t70-22.5q39 0 70 22.5t43 57.5h247v80h-80l120 280q0 50-41 85t-99 35q-58 0-99-35t-41-85l120-280H593q-9 26-28 45t-45 28v447h360v80H80Zm585-320h150l-75-174-75 174Zm-520 0h150l-75-174-75 174Zm335-280q17 0 28.5-11.5T520-760q0-17-11.5-28.5T480-800q-17 0-28.5 11.5T440-760q0 17 11.5 28.5T480-720Z"/>',
            'Brain': '<path d="M390-120q-51 0-88-35.5T260-241q-60-8-100-53t-40-106q0-21 5.5-41.5T142-480q-11-18-16.5-38t-5.5-42q0-61 40-105.5t99-52.5q3-51 41-86.5t90-35.5q26 0 48.5 10t41.5 27q18-17 41-27t49-10q52 0 89.5 35t40.5 86q59 8 99.5 53T840-560q0 22-5.5 42T818-480q11 18 16.5 38.5T840-400q0 62-40.5 106.5T699-241q-5 50-41.5 85.5T570-120q-25 0-48.5-9.5T480-156q-19 17-42 26.5t-48 9.5Zm130-590v460q0 21 14.5 35.5T570-200q20 0 34.5-16t15.5-36q-21-8-38.5-21.5T550-306q-10-14-7.5-30t16.5-26q14-10 30-7.5t26 16.5q11 16 28 24.5t37 8.5q33 0 56.5-23.5T760-400q0-5-.5-10t-2.5-10q-17 10-36.5 15t-40.5 5q-17 0-28.5-11.5T640-440q0-17 11.5-28.5T680-480q33 0 56.5-23.5T760-560q0-33-23.5-56T680-640q-11 18-28.5 31.5T613-587q-16 6-31-1t-20-23q-5-16 1.5-31t22.5-20q15-5 24.5-18t9.5-30q0-21-14.5-35.5T570-760q-21 0-35.5 14.5T520-710Zm-80 460v-460q0-21-14.5-35.5T390-760q-21 0-35.5 14.5T340-710q0 16 9 29.5t24 18.5q16 5 23 20t2 31q-6 16-21 23t-31 1q-21-8-38.5-21.5T279-640q-32 1-55.5 24.5T200-560q0 33 23.5 56.5T280-480q17 0 28.5 11.5T320-440q0 17-11.5 28.5T280-400q-21 0-40.5-5T203-420q-2 5-2.5 10t-.5 10q0 33 23.5 56.5T280-320q20 0 37-8.5t28-24.5q10-14 26-16.5t30 7.5q14 10 16.5 26t-7.5 30q-14 19-32 33t-39 22q1 20 16 35.5t35 15.5q21 0 35.5-14.5T440-250Zm40-230Z"/>'
        };
        const svgMarkup = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">${svgPaths[shapeName] || ''}</svg>`;
        const svgData = this._loader.parse(svgMarkup);
        const geometries = [];
        svgData.paths.forEach(path => {
            const shapes = SVGLoader.createShapes(path);
            shapes.forEach(shape => {
                geometries.push(new THREE.ShapeGeometry(shape));
            });
        });
        if (geometries.length === 0) {
            console.warn(`Could not generate geometry for shape: ${shapeName}`);
            return new THREE.PlaneGeometry(1, 1);
        }
        const mergedGeometry = BufferGeometryUtils.mergeGeometries(geometries);
        mergedGeometry.center();
        const scale = 1.3 / 960;
        mergedGeometry.scale(scale, -scale, scale);
        this._cache[shapeName] = mergedGeometry;
        return mergedGeometry.clone();
    }
};

// --- VUE REACTIVE STATE ---
const canvasRef = ref(null);
const wrapperRef = ref(null);
let treeApp = null;
const supabase = useSupabaseClient();
const modalStore = useModalStore();

const showLessonModal = (data) => {
  if (!data || !data.lesson || !data.lesson.id) {
      console.error("showLessonModal called with invalid data:", data);
      return;
  };
  modalStore.open(data.lesson.id);
};

onMounted(async () => {
  try {
    if (process.server) return;
    
    const skinId = '27dd5751-c18b-429c-83a4-e09cfa47403e';
    
    const { data: { user } } = await supabase.auth.getUser();
    let userId = user?.id;

    if (!userId) {
        const { data: anonUser, error } = await supabase.auth.signInAnonymously();
        if (error) throw error;
        userId = anonUser?.user?.id;
    }

    const { data: skinData, error } = await supabase.rpc('get_layout_data', { p_skin_id: skinId, p_user_id: userId });
    
    if (error) { console.error('Error loading layout data:', error); return; }
    if (!skinData || skinData.length === 0) { console.warn(`Warning: No data returned for skin ID '${skinId}'.`); return; }
    
    treeApp = new TreeApp(wrapperRef.value, canvasRef.value, skinData, showLessonModal, CONFIG, supabase);
    treeApp.init();
    
  } catch (e) { console.error(`An unexpected error occurred in onMounted: ${e.message}`); }
});

onUnmounted(() => { if (treeApp) { treeApp.destroy(); } });

// =================================================================================================
// --- CORE THREE.JS APPLICATION CLASS ---
// =================================================================================================
class TreeApp {
    constructor(wrapper, canvas, skinData, showModalCallback, config, supabase) {
        this.wrapper = wrapper;
        this.canvas = canvas;
        this.skinData = skinData;
        this.showModal = showModalCallback;
        this.config = config;
        this.supabase = supabase;
        this.animationFrameId = null;
        this.isEditMode = false;
        this.draggedObject = null;
        this.dragPlane = new THREE.Plane();
        this.dragOffset = new THREE.Vector3();
        this.font = null;
    }

    init() {
        this.initScene();
        const fontLoader = new FontLoader();
        fontLoader.load(this.config.LESSON_NODE.FONT_URL, (font) => {
            this.font = font;
            this.initModels();
            this.animate();
        });
        this.initControls();
    }

    initScene() {
        this.renderer = new THREE.WebGLRenderer({ antialias: true, canvas: this.canvas, alpha: true });
        this.renderer.setSize(this.wrapper.clientWidth, this.wrapper.clientHeight);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(75, this.wrapper.clientWidth / this.wrapper.clientHeight, 0.1, 1000);
        this.camera.position.set(...this.config.CAMERA_INITIAL_POSITION);
        this.camera.lookAt(this.scene.position);
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        this.scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(10, 20, 30);
        this.scene.add(directionalLight);
        this.mainGroup = new THREE.Group();
        this.scene.add(this.mainGroup);
        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
    }

    initModels() {
        this.createTreePlane(this.config.TREE_IMAGE);
        this.clickableObjects = [];
        this.skinData.forEach(item => {
            const lessonNode = this.createLessonNode(item);
            this.mainGroup.add(lessonNode);
            this.clickableObjects.push(lessonNode);
        });
    }

    getColorForProgress(progress) {
        const startColor = new THREE.Color(this.config.LESSON_NODE.FRUIT_COLORS.start);
        const endColor = new THREE.Color(this.config.LESSON_NODE.FRUIT_COLORS.end);
        const color = new THREE.Color();
        color.lerpColors(startColor, endColor, progress / 100);
        return color;
    }

    createLessonNode(data) {
        const group = new THREE.Group();
        group.position.set(data.coordinates.x, data.coordinates.y, data.coordinates.z);
        group.scale.setScalar(this.config.LESSON_NODE.SCALE);
        if (data.rotation) {
            group.rotation.z = data.rotation * (Math.PI / 180);
        }
        group.userData = data;

        const isCore = data.lesson.is_core;
        const fruitColor = isCore ? 0x6e583f : this.getColorForProgress(data.lesson.progress);
        const fruitMaterial = isCore 
            ? new THREE.MeshStandardMaterial({ color: fruitColor, roughness: 0.8 })
            : new THREE.MeshBasicMaterial({ color: fruitColor });
        
        const fruitGeometry = new THREE.CircleGeometry(1.2, 64);
        const fruitMesh = new THREE.Mesh(fruitGeometry, fruitMaterial);
        group.add(fruitMesh);

        const iconGeometry = IconFactory.createGeometry(data.shape);
        const iconMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
        const iconMesh = new THREE.Mesh(iconGeometry, iconMaterial);
        iconMesh.position.set(0, 0.3, 0.01);
        iconMesh.scale.setScalar(0.8);
        group.add(iconMesh);

        const shapes = this.font.generateShapes( data.lesson.game_id.toString(), this.config.LESSON_NODE.TEXT_SIZE );
        const textGeometry = new THREE.ShapeGeometry( shapes );
        textGeometry.center();
        
        const textMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
        const textMesh = new THREE.Mesh(textGeometry, textMaterial);
        textMesh.position.set(0, -0.6, 0.01);
        group.add(textMesh);

        return group;
    }

    createTreePlane(imageInfo) {
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load(imageInfo.url, (texture) => {
            const geometry = new THREE.PlaneGeometry(imageInfo.width, imageInfo.height);
            const material = new THREE.MeshBasicMaterial({ 
                map: texture,
                transparent: true
            });
            const plane = new THREE.Mesh(geometry, material);
            plane.position.set(...imageInfo.position);
            this.mainGroup.add(plane);
        }, undefined, (error) => {
            console.error('An error happened while loading the tree image:', error);
        });
    }
    
    initControls() {
        this.mouseMoved = false;
        this.touchMoved = false;
        this.previousMousePosition = { x: 0, y: 0 };
        this.initialPinchDistance = 0;

        this.onKeyDown = this.onKeyDown.bind(this);
        this.onMouseDown = this.onMouseDown.bind(this);
        this.onMouseMove = this.onMouseMove.bind(this);
        this.onMouseUp = this.onMouseUp.bind(this);
        this.onWheel = this.onWheel.bind(this);
        this.onWindowResize = this.onWindowResize.bind(this);
        this.onTouchStart = this.onTouchStart.bind(this);
        this.onTouchMove = this.onTouchMove.bind(this);
        this.onTouchEnd = this.onTouchEnd.bind(this);
        
        this.canvas.addEventListener('mousedown', this.onMouseDown);
        this.canvas.addEventListener('touchstart', this.onTouchStart, { passive: false });
        this.canvas.addEventListener('touchmove', this.onTouchMove, { passive: false });
        this.canvas.addEventListener('touchend', this.onTouchEnd);
        window.addEventListener('keydown', this.onKeyDown);
        window.addEventListener('wheel', this.onWheel);
        window.addEventListener('resize', this.onWindowResize);
    }
    
    onKeyDown(e) {
        if (e.shiftKey && e.key.toLowerCase() === 'e') {
            this.isEditMode = !this.isEditMode;
            this.canvas.style.cursor = this.isEditMode ? 'grab' : 'default';
            if (this.wrapper) { 
                this.wrapper.style.border = this.isEditMode ? '2px solid #00ff00' : 'none'; 
                this.wrapper.style.boxSizing = 'border-box'; 
            }
            console.log(`Edit mode: ${this.isEditMode ? 'ON' : 'OFF'}`);
        }
    }

    onMouseDown(e) {
        this.mouseMoved = false;
        this.previousMousePosition.x = e.clientX;
        this.previousMousePosition.y = e.clientY;
        if (this.isEditMode) {
            this.startDragging(e);
        }
        window.addEventListener('mousemove', this.onMouseMove);
        window.addEventListener('mouseup', this.onMouseUp);
    }

    onMouseMove(e) {
        this.mouseMoved = true;
        if (this.isEditMode && this.draggedObject) {
            this.dragObject(e);
        } else {
            const deltaX = e.clientX - this.previousMousePosition.x;
            const deltaY = e.clientY - this.previousMousePosition.y;
            this.mainGroup.position.x += deltaX * this.config.PAN_SENSITIVITY;
            this.mainGroup.position.y -= deltaY * this.config.PAN_SENSITIVITY;
        }
        this.previousMousePosition.x = e.clientX;
        this.previousMousePosition.y = e.clientY;
    }

    async onMouseUp(e) {
        window.removeEventListener('mousemove', this.onMouseMove);
        window.removeEventListener('mouseup', this.onMouseUp);
        if (this.isEditMode && this.draggedObject) {
            await this.stopDragging();
        }
        if (!this.mouseMoved && !this.isEditMode) {
            this.handleClick(e);
        }
    }

    onWheel(e) {
        const zoomAmount = e.deltaY * this.config.ZOOM_SENSITIVITY;
        const newScale = this.mainGroup.scale.x - zoomAmount * 0.1;
        this.mainGroup.scale.setScalar(THREE.MathUtils.clamp(newScale, this.config.ZOOM_RANGE.min, this.config.ZOOM_RANGE.max));
    }

    getTouchDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
    }

    onTouchStart(e) {
        e.preventDefault();
        this.touchMoved = false;
        const touches = e.touches;
        if (touches.length === 1) {
            this.previousMousePosition.x = touches[0].clientX;
            this.previousMousePosition.y = touches[0].clientY;
            if (this.isEditMode) {
                this.startDragging(touches[0]);
            }
        } else if (touches.length === 2) {
            this.initialPinchDistance = this.getTouchDistance(touches);
        }
    }

    onTouchMove(e) {
        e.preventDefault();
        this.touchMoved = true;
        const touches = e.touches;
        if (this.isEditMode && this.draggedObject) {
            this.dragObject(touches[0]);
        } else if (touches.length === 1) {
            const deltaX = touches[0].clientX - this.previousMousePosition.x;
            const deltaY = touches[0].clientY - this.previousMousePosition.y;
            this.mainGroup.position.x += deltaX * this.config.PAN_SENSITIVITY;
            this.mainGroup.position.y -= deltaY * this.config.PAN_SENSITIVITY;
            this.previousMousePosition.x = touches[0].clientX;
            this.previousMousePosition.y = touches[0].clientY;
        } else if (touches.length === 2) {
            const newPinchDistance = this.getTouchDistance(touches);
            const deltaDistance = newPinchDistance - this.initialPinchDistance;
            const newScale = this.mainGroup.scale.x + deltaDistance * 0.01;
            this.mainGroup.scale.setScalar(THREE.MathUtils.clamp(newScale, this.config.ZOOM_RANGE.min, this.config.ZOOM_RANGE.max));
            this.initialPinchDistance = newPinchDistance;
        }
    }

    async onTouchEnd(e) {
        e.preventDefault();
        if (this.isEditMode && this.draggedObject) {
            await this.stopDragging();
        }
        if (!this.touchMoved && e.changedTouches.length === 1) {
            const touch = e.changedTouches[0];
            this.handleClick({ clientX: touch.clientX, clientY: touch.clientY });
        }
    }

    onWindowResize() {
        this.camera.aspect = this.wrapper.clientWidth / this.wrapper.clientHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(this.wrapper.clientWidth, this.wrapper.clientHeight);
    }

    handleClick(e) {
        if (this.isEditMode) return;
        this.mouse.x = (e.clientX / this.wrapper.clientWidth) * 2 - 1;
        this.mouse.y = -((e.clientY - this.wrapper.getBoundingClientRect().top) / this.wrapper.clientHeight) * 2 + 1;
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const intersects = this.raycaster.intersectObjects(this.clickableObjects, true);
        if (intersects.length > 0) {
            let clickedObject = intersects[0].object;
            while (clickedObject.parent && !clickedObject.userData.lesson) {
                clickedObject = clickedObject.parent;
            }
            if (clickedObject.userData.lesson) {
                this.showModal(clickedObject.userData);
            }
        }
    }

    startDragging(e) {
        this.mouse.x = (e.clientX / this.wrapper.clientWidth) * 2 - 1; this.mouse.y = -((e.clientY - this.wrapper.getBoundingClientRect().top) / this.wrapper.clientHeight) * 2 + 1;
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const intersects = this.raycaster.intersectObjects(this.clickableObjects, true);
        if (intersects.length > 0) {
            let objectToDrag = intersects[0].object;
             while (objectToDrag.parent && !objectToDrag.userData.lesson) {
                objectToDrag = objectToDrag.parent;
            }
            this.draggedObject = objectToDrag;
            const intersectionPoint = intersects[0].point;
            const objectWorldPos = new THREE.Vector3();
            this.draggedObject.getWorldPosition(objectWorldPos);
            this.dragOffset.copy(intersectionPoint).sub(objectWorldPos);
            this.dragPlane.setFromNormalAndCoplanarPoint(this.camera.getWorldDirection(this.dragPlane.normal), intersectionPoint);
            this.canvas.style.cursor = 'grabbing';
        }
    }

    dragObject(e) {
        this.mouse.x = (e.clientX / this.wrapper.clientWidth) * 2 - 1; this.mouse.y = -((e.clientY - this.wrapper.getBoundingClientRect().top) / this.wrapper.clientHeight) * 2 + 1;
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const intersectionPoint = new THREE.Vector3(); 
        this.raycaster.ray.intersectPlane(this.dragPlane, intersectionPoint);
        const targetWorldPos = intersectionPoint.sub(this.dragOffset);
        this.mainGroup.worldToLocal(this.draggedObject.position.copy(targetWorldPos));
    }

    async stopDragging() {
        const newCoords = { x: this.draggedObject.position.x, y: this.draggedObject.position.y, z: this.draggedObject.position.z };
        const lessonData = this.draggedObject.userData;
        console.log(`Saving new coordinates for layout ${lessonData.layout_id}:`, newCoords);
        const { data, error } = await this.supabase.from('skin_layouts').update({ coordinates: newCoords }).eq('id', lessonData.layout_id).select();
        if (error) { console.error("Error updating coordinates:", error); } 
        else { lessonData.coordinates = newCoords; console.log("Save successful! Response from DB:", data); }
        this.draggedObject = null; this.canvas.style.cursor = 'grab';
    }

    animate() {
        this.animationFrameId = requestAnimationFrame(() => this.animate());
        this.renderer.render(this.scene, this.camera);
    }

    destroy() {
        if (this.animationFrameId) { cancelAnimationFrame(this.animationFrameId); }
        if (this.wrapper) { 
            this.wrapper.style.border = 'none'; 
            this.wrapper.style.boxSizing = 'content-box'; 
        }
        this.canvas.removeEventListener('mousedown', this.onMouseDown);
        this.canvas.removeEventListener('touchstart', this.onTouchStart);
        this.canvas.removeEventListener('touchmove', this.onTouchMove);
        this.canvas.removeEventListener('touchend', this.onTouchEnd);
        window.removeEventListener('keydown', this.onKeyDown);
        window.removeEventListener('wheel', this.onWheel);
        window.removeEventListener('resize', this.onWindowResize);
        
        this.scene.traverse(object => {
            if (object.geometry) object.geometry.dispose();
            if (object.material) {
                if (Array.isArray(object.material)) {
                    object.material.forEach(material => material.dispose());
                } else {
                    object.material.dispose();
                }
            }
        });
        this.renderer.dispose();
    }
}
</script>

<style scoped>
.sv-wrapper {
  width: 100%;
  height: 100%;
  overflow: hidden;
}
canvas {
  display: block;
}
</style>
